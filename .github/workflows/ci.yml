name: ci

on:
  push:
  pull_request:

jobs:
  openwatcom:
    name: openwatcom-win16-win9x
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Open Watcom
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y curl python3
          urls=(
            "https://github.com/open-watcom/open-watcom-v2/releases/download/2025-12-01-Build/open-watcom-2_0-c-linux-x64"
            "https://downloads.sourceforge.net/project/openwatcom/open-watcom-2.0/open-watcom-2_0-linux-x64.tar.bz2"
            "https://downloads.sourceforge.net/project/openwatcom/open-watcom-2.0/open-watcom-2_0-linux-x64.tar.bz2?download=1"
            "https://sourceforge.net/projects/openwatcom/files/open-watcom-2.0/open-watcom-2_0-linux-x64.tar.bz2/download"
          )
          for url in "${urls[@]}"; do
            echo "Attempting Open Watcom download from $url"
            if curl -fL -o /tmp/openwatcom.tar.bz2 "$url"; then
              if tar -tf /tmp/openwatcom.tar.bz2 >/dev/null 2>&1; then
                break
              fi
            fi
          done
          tar -tf /tmp/openwatcom.tar.bz2 >/dev/null 2>&1
          sudo mkdir -p /opt/openwatcom
          sudo tar -xf /tmp/openwatcom.tar.bz2 -C /opt/openwatcom --strip-components=1
          echo "WATCOM=/opt/openwatcom" >> "$GITHUB_ENV"
          echo "/opt/openwatcom/binl64" >> "$GITHUB_PATH"

      - name: Build Win16 + Win9x + INF templates
        run: |
          set -euo pipefail
          make windows-openwatcom

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwatcom-windows
          path: dist/windows/**

  win32:
    name: windows-win32-user-mode
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Win32 user-mode
        run: powershell -File scripts/windows-build.ps1

      - name: Upload Win32 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win32-user-mode
          path: dist/windows/win32/**

  macos:
    name: macos-universal
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build macOS universal
        run: bash scripts/macos-build.sh

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: dist/macos/**
