name: ci

on:
  push:
  pull_request:

jobs:
  openwatcom:
    name: openwatcom-win16-win9x
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Open Watcom
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y curl python3
          curl -L -o /tmp/openwatcom.tar.gz https://github.com/open-watcom/open-watcom-v2/releases/download/2.0.0/open-watcom-2_0-linux-x64.tar.gz
          sudo mkdir -p /opt/openwatcom
          sudo tar -xzf /tmp/openwatcom.tar.gz -C /opt/openwatcom --strip-components=1
          echo "WATCOM=/opt/openwatcom" >> "$GITHUB_ENV"
          echo "/opt/openwatcom/binl64" >> "$GITHUB_PATH"

      - name: Build Win16 + Win9x + INF templates
        run: |
          set -euo pipefail
          make windows-openwatcom

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwatcom-windows
          path: dist/windows/**

  win32:
    name: windows-win32-user-mode
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Win32 user-mode
        run: powershell -File scripts/windows-build.ps1

      - name: Upload Win32 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win32-user-mode
          path: dist/windows/win32/**

  macos:
    name: macos-universal
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build macOS universal
        run: bash scripts/macos-build.sh

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: dist/macos/**
