name: ci

on:
  push:
  pull_request:

jobs:
  openwatcom:
    name: openwatcom-win16-win9x
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Open Watcom
        run: |
          set -euo pipefail
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y curl python3 xvfb libc6:i386 libstdc++6:i386 libncurses6:i386 libtinfo6:i386
          if [ ! -e /usr/share/terminfo ]; then
            sudo ln -s /lib/terminfo /usr/share/terminfo
          fi
          export TERM=xterm
          export TERMINFO=/usr/share/terminfo
          url="https://github.com/open-watcom/open-watcom-v2/releases/download/2025-12-01-Build/open-watcom-2_0-c-linux-x64"
          curl -fL -o /tmp/openwatcom-installer "$url"
          chmod +x /tmp/openwatcom-installer
          sudo mkdir -p /opt/openwatcom
          sudo xvfb-run -a /tmp/openwatcom-installer \
            --mode unattended \
            --target /opt/openwatcom
          test -x /opt/openwatcom/binl64/wcc
          echo "WATCOM=/opt/openwatcom" >> "$GITHUB_ENV"
          echo "/opt/openwatcom/binl64" >> "$GITHUB_PATH"

      - name: Build Win16 + Win9x + INF templates
        run: |
          set -euo pipefail
          make windows-openwatcom

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openwatcom-windows
          path: dist/windows/**

  win32:
    name: windows-win32-user-mode
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Win32 user-mode
        run: powershell -File scripts/windows-build.ps1

      - name: Upload Win32 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win32-user-mode
          path: dist/windows/win32/**

  macos:
    name: macos-universal
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build macOS universal
        run: bash scripts/macos-build.sh

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: dist/macos/**
